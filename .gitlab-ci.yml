# GitLab CI/CD é…ç½®æ–‡ä»¶ - èŠå¤©åº”ç”¨
# ç²¾ç®€ç‰ˆæœ¬ï¼šåªè¿è¡Œ SonarQube ä»£ç è´¨é‡æ£€æŸ¥

stages:
  - sonarqube-test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Xmx2048m"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"  # å®Œæ•´Gitå†å²ç”¨äºSonarQubeåˆ†æ

# å…¨å±€ç¼“å­˜é…ç½®
cache:
  key: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}"
  paths:
    - .m2/repository/
    - .sonar/cache/
  policy: pull-push

# SonarQubeä»£ç è´¨é‡åˆ†æï¼ˆåŒ…å«æœ€å°ç¼–è¯‘ï¼‰
sonarqube-test:
  stage: sonarqube-test
  image: maven:3.8.6-openjdk-11
  variables:
    SONAR_TOKEN: $SONAR_TOKEN
    SONAR_HOST_URL: $SONAR_HOST_URL
  before_script:
    - echo "ğŸ” å‡†å¤‡SonarQubeåˆ†æç¯å¢ƒ..."
    - |
      if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
        echo "âŒ SonarQubeé…ç½®ç¼ºå¤±ï¼è¯·è®¾ç½® SONAR_HOST_URL å’Œ SONAR_TOKEN å˜é‡"
        echo "ğŸ’¡ æç¤ºï¼šå¯ä»¥åœ¨ GitLab é¡¹ç›®è®¾ç½® -> CI/CD -> Variables ä¸­æ·»åŠ ï¼š"
        echo "   SONAR_HOST_URL = http://localhost:9000 (æˆ–æ‚¨çš„SonarQubeåœ°å€)"
        echo "   SONAR_TOKEN = æ‚¨çš„SonarQubeä»¤ç‰Œ"
        exit 1
      fi
  script:
    - echo "âš¡ å¿«é€Ÿç¼–è¯‘ï¼ˆè·³è¿‡æµ‹è¯•ï¼‰..."
    - mvn $MAVEN_CLI_OPTS clean compile -DskipTests -T 1C
    - echo "ğŸ” è¿è¡ŒSonarQubeä»£ç è´¨é‡åˆ†æ..."
    - |
      # æ£€æŸ¥æ˜¯å¦æ˜¯åˆå¹¶è¯·æ±‚
      if [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ]; then
        echo "ğŸ“‹ åˆ†æåˆå¹¶è¯·æ±‚ #$CI_MERGE_REQUEST_IID"
        mvn $MAVEN_CLI_OPTS sonar:sonar \
          -Dsonar.projectKey=chat-app \
          -Dsonar.projectName="Chat Application" \
          -Dsonar.host.url="$SONAR_HOST_URL" \
          -Dsonar.login="$SONAR_TOKEN" \
          -Dsonar.pullrequest.key="$CI_MERGE_REQUEST_IID" \
          -Dsonar.pullrequest.branch="$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" \
          -Dsonar.pullrequest.base="$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" \
          -Dsonar.qualitygate.wait=true \
          -Dsonar.qualitygate.timeout=300
      else
        echo "ğŸŒ¿ åˆ†æåˆ†æ”¯: $CI_COMMIT_REF_NAME"
        mvn $MAVEN_CLI_OPTS sonar:sonar \
          -Dsonar.projectKey=chat-app \
          -Dsonar.projectName="Chat Application" \
          -Dsonar.host.url="$SONAR_HOST_URL" \
          -Dsonar.login="$SONAR_TOKEN" \
          -Dsonar.branch.name="$CI_COMMIT_REF_NAME" \
          -Dsonar.qualitygate.wait=true \
          -Dsonar.qualitygate.timeout=300
      fi
    - echo "ğŸ“Š SonarQubeåˆ†æå®Œæˆï¼"
    - echo "ğŸ”— æŸ¥çœ‹æŠ¥å‘Šï¼š$SONAR_HOST_URL/dashboard?id=chat-app"
  artifacts:
    reports:
      junit:
        - "**/target/surefire-reports/TEST-*.xml"
    paths:
      - ".sonar/"
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: false

# æˆåŠŸé€šçŸ¥
notify-success:
  stage: .post
  image: alpine:latest
  script:
    - echo "ğŸ‰ SonarQube ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆï¼"
    - echo "ğŸ“¦ é¡¹ç›®: $CI_PROJECT_NAME"
    - echo "ğŸŒ¿ åˆ†æ”¯: $CI_COMMIT_REF_NAME"
    - echo "ğŸ’¿ æäº¤: $CI_COMMIT_SHA"
    - echo "ğŸ”— æµæ°´çº¿: $CI_PIPELINE_URL"
    - echo "ğŸ“Š SonarQubeæŠ¥å‘Š: $SONAR_HOST_URL/dashboard?id=chat-app"
    - echo "âš¡ è·³è¿‡äº†å®Œæ•´æ„å»ºï¼ŒèŠ‚çœæ—¶é—´ï¼"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "develop"
      when: on_success 